<main id="main-content" class="flex h-[calc(100vh-4rem)]">
  <section id="chat-conversation" class="flex-1 bg-white flex flex-col">
    <!-- Chat Header -->
    <div id="chat-header" class="p-4 border-b border-neutral-200 bg-white">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <button
            class="text-neutral-400 hover:text-neutral-600 lg:hidden"
            (click)="onBackButtonClick()"
            aria-label="Back to conversations">
            <i class="fa-solid fa-arrow-left text-xl"></i>
          </button>

          @if (participant(); as user) {
            <img
              [src]="user.avatarUrl"
              [alt]="user.name"
              class="w-10 h-10 rounded-full">
            <div>
              <div class="flex items-center space-x-2">
                <h3 class="text-lg text-black">{{ user.name }}</h3>
                <div
                  class="w-2 h-2 rounded-full"
                  [class.bg-green-500]="user.status === 'online'"
                  [class.bg-neutral-500]="user.status === 'offline'"
                  [class.bg-yellow-500]="user.status === 'away'">
                </div>
              </div>
              <p class="text-sm text-neutral-500">
                @if (user.status === 'online') {
                  Active now
                } @else if (user.lastSeen) {
                  Last seen {{ formatTime(user.lastSeen) }}
                } @else {
                  Offline
                }
              </p>
            </div>
          }
        </div>

        <button
          class="text-neutral-400 hover:text-neutral-600"
          (click)="onUserProfileClick()"
          aria-label="View user profile">
          <i class="fa-solid fa-user text-xl"></i>
        </button>
      </div>
    </div>

    <!-- Message Area -->
    <div
      #messageArea
      id="message-area"
      class="flex-1 overflow-y-auto p-4 space-y-4"
      (scroll)="onMessageScroll($event)">

      @if (chatState.loading()) {
        <div class="flex justify-center py-4">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-neutral-500"></div>
        </div>
      }

      @for (message of messages(); track message.id) {
        @if (isOwnMessage(message)) {
          <!-- Own Message (Right-aligned) -->
          <div class="flex items-start space-x-3 justify-end">
            <div class="flex-1  text-right">
              @if (message.type === 'file' && message.attachment) {
                <div class="bg-neutral-500 text-white rounded-lg p-3 inline-block">
                  <button
                    class="bg-neutral-600 rounded-lg p-3 mb-2 cursor-pointer hover:bg-neutral-700"
                    (click)="onAttachmentDownload(message.attachment)">
                    <div class="flex items-center space-x-2">
                      <i [class]="'fa-solid ' + getFileIcon(message.attachment.fileType) + ' text-white'"></i>
                      <span class="text-sm">{{ message.attachment.fileName }}</span>
                    </div>
                    <p class="text-xs text-neutral-300 mt-1">
                      {{ formatFileSize(message.attachment.fileSize) }}
                    </p>
                  </button>
                </div>
              } @else {
                <div
                  class="bg-neutral-500 text-white rounded-lg p-3 inline-block"
                  (contextmenu)="onMessageContextMenu(message, $event)">
                  <p class="text-sm">{{ message.content }}</p>
                </div>
              }

              <div class="flex items-center justify-end space-x-2 mt-1">
                <p class="text-xs text-neutral-500">{{ formatTime(message.timestamp) }}</p>
                @if (message.status === 'sending') {
                  <i class="fa-solid fa-clock text-xs text-neutral-400"></i>
                } @else if (message.status === 'sent') {
                  <i class="fa-solid fa-check text-xs text-neutral-400"></i>
                } @else if (message.status === 'delivered') {
                  <i class="fa-solid fa-check-double text-xs text-neutral-400"></i>
                } @else if (message.status === 'read') {
                  <i class="fa-solid fa-check-double text-xs text-blue-500"></i>
                }
              </div>
            </div>
          </div>
        } @else {
          <!-- Other's Message (Left-aligned) -->
          <div class="flex items-start space-x-3">
            @if (participant(); as user) {
              <img
                [src]="user.avatarUrl"
                [alt]="user.name"
                class="w-8 h-8 rounded-full">
            }
            <div class="flex-1 max-w-xs">
              @if (message.type === 'file' && message.attachment) {
                <div class="bg-neutral-100 rounded-lg p-3">
                  <div
                    class="bg-neutral-200 rounded-lg p-3 mb-2 cursor-pointer hover:bg-neutral-300"
                    (click)="onAttachmentDownload(message.attachment)">
                    <div class="flex items-center space-x-2">
                      <i [class]="'fa-solid ' + getFileIcon(message.attachment.fileType) + ' text-neutral-500'"></i>
                      <span class="text-sm text-black">{{ message.attachment.fileName }}</span>
                    </div>
                    <p class="text-xs text-neutral-500 mt-1">
                      {{ formatFileSize(message.attachment.fileSize) }}
                    </p>
                  </div>
                  @if (message.content) {
                    <p class="text-sm text-black">{{ message.content }}</p>
                  }
                </div>
              } @else {
                <div
                  class="bg-neutral-100 rounded-lg p-3"
                  (contextmenu)="onMessageContextMenu(message, $event)">
                  <p class="text-sm text-black">{{ message.content }}</p>
                </div>
              }
              <p class="text-xs text-neutral-500 mt-1">{{ formatTime(message.timestamp) }}</p>
            </div>
          </div>
        }
      }
    </div>

    <!-- Message Input -->
    <div id="message-input" class="p-4 border-t border-neutral-200 bg-white">
      <div class="flex items-end space-x-3">
        <input
          type="file"
          #fileInput
          (change)="onFileSelected($event)"
          hidden>

        <button
          class="p-2 text-neutral-400 hover:text-neutral-600 disabled:opacity-50"
          (click)="onAttachmentClick()"
          [disabled]="uploadingFile()"
          aria-label="Attach file">
          @if (uploadingFile()) {
            <i class="fa-solid fa-spinner fa-spin text-xl"></i>
          } @else {
            <i class="fa-solid fa-paperclip text-xl"></i>
          }
        </button>

        <div class="flex-1">
          <textarea
            #messageTextarea
            [value]="messageContent()"
            (input)="onTextareaInput($event)"
            (keydown)="onTextareaKeydown($event)"
            placeholder="Type a message..."
            rows="1"
            [disabled]="sendingMessage()"
            class="w-full px-4 py-3 border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-neutral-500 resize-none disabled:opacity-50 disabled:cursor-not-allowed"></textarea>
        </div>

        <button
          (click)="onSendClick()"
          [disabled]="!messageContent().trim() || sendingMessage()"
          class="bg-neutral-500 text-white p-3 rounded-lg hover:bg-neutral-600 focus:outline-none focus:ring-2 focus:ring-neutral-500 disabled:opacity-50 disabled:cursor-not-allowed"
          aria-label="Send message">
          @if (sendingMessage()) {
            <i class="fa-solid fa-spinner fa-spin"></i>
          } @else {
            <i class="fa-solid fa-paper-plane"></i>
          }
        </button>
      </div>
    </div>

    <!-- Error Card -->
    @if (error(); as err) {
      <div id="error-card" class="p-4 m-4 bg-neutral-50 border border-neutral-200 rounded-lg">
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-neutral-100 rounded-full flex items-center justify-center">
            <i class="fa-solid fa-exclamation-triangle text-neutral-600"></i>
          </div>
          <div class="flex-1">
            <h4 class="text-sm text-neutral-800">{{ err.message }}</h4>
            <p class="text-xs text-neutral-600">{{ err.description }}</p>
          </div>
          <button
            class="text-neutral-400 hover:text-neutral-600"
            (click)="onErrorDismiss()"
            aria-label="Dismiss error">
            <i class="fa-solid fa-times"></i>
          </button>
        </div>
      </div>
    }
  </section>
</main>
